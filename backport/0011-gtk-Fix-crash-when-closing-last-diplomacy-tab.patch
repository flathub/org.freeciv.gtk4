From e18defdc0f4900be575af4a354cf2eb741fdc875 Mon Sep 17 00:00:00 2001
From: Marko Lindqvist <cazfi74@gmail.com>
Date: Sat, 6 Jul 2024 11:35:39 +0300
Subject: [PATCH 11/11] gtk: Fix crash when closing last diplomacy tab

See RM #750

Signed-off-by: Marko Lindqvist <cazfi74@gmail.com>
---
 client/gui-gtk-3.0/diplodlg.c  | 4 +++-
 client/gui-gtk-3.22/diplodlg.c | 4 +++-
 client/gui-gtk-4.0/diplodlg.c  | 4 +++-
 3 files changed, 9 insertions(+), 3 deletions(-)

diff --git a/client/gui-gtk-3.0/diplodlg.c b/client/gui-gtk-3.0/diplodlg.c
index 6126f44181..4066a26810 100644
--- a/client/gui-gtk-3.0/diplodlg.c
+++ b/client/gui-gtk-3.0/diplodlg.c
@@ -612,7 +612,6 @@ static void diplomacy_destroy(struct Diplomacy_dialog* pdialog)
     pdialog->dialog = NULL;
   }
   dialog_list_remove(dialog_list, pdialog);
-  free(pdialog);
 
   if (dialog_list) {
     /* Diplomatic meetings in one main tab. */
@@ -629,6 +628,9 @@ static void diplomacy_destroy(struct Diplomacy_dialog* pdialog)
       diplomacy_main_destroy();
     }
   }
+
+  /* Last sub-tab must not be freed before diplomacy_main_destroy() call. */
+  free(pdialog);
 }
 
 /************************************************************************//**
diff --git a/client/gui-gtk-3.22/diplodlg.c b/client/gui-gtk-3.22/diplodlg.c
index 495fa89f0b..729068ee7c 100644
--- a/client/gui-gtk-3.22/diplodlg.c
+++ b/client/gui-gtk-3.22/diplodlg.c
@@ -610,7 +610,6 @@ static void diplomacy_destroy(struct Diplomacy_dialog* pdialog)
     pdialog->dialog = NULL;
   }
   dialog_list_remove(dialog_list, pdialog);
-  free(pdialog);
 
   if (dialog_list) {
     /* Diplomatic meetings in one main tab. */
@@ -627,6 +626,9 @@ static void diplomacy_destroy(struct Diplomacy_dialog* pdialog)
       diplomacy_main_destroy();
     }
   }
+
+  /* Last sub-tab must not be freed before diplomacy_main_destroy() call. */
+  free(pdialog);
 }
 
 /************************************************************************//**
diff --git a/client/gui-gtk-4.0/diplodlg.c b/client/gui-gtk-4.0/diplodlg.c
index 6168063e08..ef4d5b7b58 100644
--- a/client/gui-gtk-4.0/diplodlg.c
+++ b/client/gui-gtk-4.0/diplodlg.c
@@ -675,7 +675,6 @@ static void diplomacy_destroy(struct Diplomacy_dialog *pdialog)
     pdialog->dialog = NULL;
   }
   dialog_list_remove(dialog_list, pdialog);
-  free(pdialog);
 
   if (dialog_list) {
     /* Diplomatic meetings in one main tab. */
@@ -692,6 +691,9 @@ static void diplomacy_destroy(struct Diplomacy_dialog *pdialog)
       diplomacy_main_destroy();
     }
   }
+
+  /* Last sub-tab must not be freed before diplomacy_main_destroy() call. */
+  free(pdialog);
 }
 
 /************************************************************************//**
-- 
2.43.0

